---
title: '微信小程序开发与原理'
date: 2019-03-23 11:26:12
tags:
---

## 小程序实战
![小程序流程.png](https://upload-images.jianshu.io/upload_images/202755-54481ef3a009f4f1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

今天做微信小程序的分享，主要分为两部分，第一部分将小程序的更新机制、双线程和运行机制。第二部分讲志愿者小程序的项目架构和业务梳理以及目前存在的问题和优化方案。这次的分享前半部分偏理论，后半部分偏实战和业务。

我们先来看第一部分。

小程序说简单也简单，说难也难，对于这个框架简单，但是小程序的源码是闭源的。

## 小程序的诞生

小程序并非凭空冒出来的一个概念。微信发布了一整套网页开发工具包，称之为 JS-SDK，开放了拍摄、录音、语音识别、二维码、地图、支付、分享、卡券等几十个API。让所有开发者都可以使用到微信的原生能力，去完成一些之前做不到或者难以做到的事情了。

video 播放器 h5的解决方案比较弱 调二维码 h5地理定位。

JS-SDK 解决了移动网页能力不足的问题，通过暴露微信的接口使得 Web 开发者能够拥有更多的能力，然而在更多的能力之外，JS-SDK 的模式并没有解决使用移动网页遇到的体验不良的问题。


微信面临的问题：如何设计一个比较好的系统，使得所有开发者在微信中都能获得比较好的体验。这个问题是之前的 JS-SDK 所处理不了的，需要一个全新的系统来完成，它需要使得所有的开发者都能做到：

小程序的本质是hbrid的开发
1. 丰富的客户端能力  api 组件多
2. 优良的离线性 

- 快速的加载

- 更强大的能力

- 原生的体验

- 易用且安全的微信数据开放

- 高效和简单的开发

这就是小程序的由来。

## 小程序与普通网页开发的区别


​ 小程序的主要开发语言是 JavaScript ，所以通常小程序的开发会被用来同普通的网页开发来做对比。两者有很大的相似性，对于前端开发者而言，从网页开发迁移到小程序的开发成本并不高，但是二者还是有些许区别的。

​ 网页开发渲染线程和脚本线程是互斥的，这也是为什么长时间的脚本运行可能会导致页面失去响应，而在小程序中，二者是分开的，分别运行在不同的线程中。网页开发者可以使用到各种浏览器暴露出来的 DOM API，进行 DOM 选中和操作。而如上文所述，小程序的逻辑层和渲染层是分开的，逻辑层运行在 JSCore 中，并没有一个完整浏览器对象，因而缺少相关的DOM API和BOM API。这一区别导致了前端开发非常熟悉的一些库，例如 jQuery、 Zepto 等，在小程序中是无法运行的。同时 JSCore 的环境同 NodeJS 环境也是不尽相同，所以一些 NPM 的包在小程序中也是无法运行的。

​ 网页开发者需要面对的环境是各式各样的浏览器，PC 端需要面对 IE、Chrome、QQ浏览器等，在移动端需要面对Safari、Chrome以及 iOS、Android 系统中的各式 WebView 。而小程序开发过程中需要面对的是两大操作系统 iOS 和 Android 的微信客户端，以及用于辅助开发的小程序开发者工具，小程序中三大运行环境也是有所区别的，

## 小程序的更新机制

手机得存储卡里 微信会下载很多小程序 小程序都是异步的没有同步概念这个概念 
没更新就不更新 更新就返回新包 在微信后台悄悄下载 下一次打开才会生效

 旧的小程序 然后微信后台进行校验 请求校验 有没有更新版本 有的话就给你下载到后台 下次打开就新的 
 
 ![小程序包的管理机制.jpg](https://upload-images.jianshu.io/upload_images/202755-bfdbe261849ce90a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
 
 ![包更新.png](https://upload-images.jianshu.io/upload_images/202755-5a5f89ec52c192e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 小程序的运行中

### 渲染层和逻辑层

小程序的运行环境分成渲染层和逻辑层， WXML 模板和 WXSS 样式工作在渲染层，JS 脚本工作在逻辑层。

![渲染层逻辑层.png](https://upload-images.jianshu.io/upload_images/202755-8be839b21840dd16.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 小程序的数据驱动基本原理

WXML结构实际上等价于一棵Dom树，通过一个JS对象也可以来表达Dom树的结构。

![逻辑层传递数据到渲染层.png](https://upload-images.jianshu.io/upload_images/202755-012421324422ca56.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![数据驱动.png](https://upload-images.jianshu.io/upload_images/202755-53bef5517dff7b6a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![逻辑层传递数据到渲染层.png](https://upload-images.jianshu.io/upload_images/202755-bfe48a240825e46e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![图片上传](https://upload-images.jianshu.io/upload_images/202755-20e79e4551d4dc7d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 小程序运行机制

### 前后台状态

小程序启动后，界面被展示给用户，此时小程序处于前台状态。

当用户点击右上角按钮关闭小程序，或者按了设备home 键离开小程序，小程序并没有完全终止运行，而是进入了后台状态，小程序还可以运行一小段时间。

当用户再次进入微信或再次打开小城，小程序又会从后台进入前台。但如果用户很久没有进入小程序，或者系统资源紧张，小程序可能被销毁，既完全终止运行。

### 小程序启动

这样，小程序启动可以分为两种情况，一种是冷启动，一种是热启动。

**冷启动：**

如果用户首次打开，或小程序销毁后被用户再次打开，此时小程序需要重新加载启动，既冷启动。

**热启动：**

如果用户已经打开过某小程序，然后在一定时间内再次打开该小程序，此时小程序并未被销毁，只是从后台状态进入前台，这个过程就是热启动。

**小程序销毁时机：**

通常，只有当小程序进入后台一定时间，或者系统资源占用过高，才会被销毁。具体而言包括以下几种情形。

当小程序进入后台，可以会位置一小段时间的运行状态，如果这段时间内都微进入前台，消息恒旭会被销毁。当小程序占用系统资源过高，可能会被系统销毁或被微信客户端主动回收。

- 在ios上，当微信客户端在一定时间间隔内（目前是5s） 连续收到两次及以上系统内存告警时，会主动进行小程序的销毁，并提示用户【该小程序可能导致微信响应变慢被终止】。
- 
建议小城在必要时使用 `wx.onMemoryWarning` 监听内存告警事件，进行必要的内存清理。

**退出状态：**

每当小程序可能被销毁之前，页面回调函数 `onSaveExitState` 会被调用。如果想保留页面中的状态，可以再这个回调函数中“保存”一些数据，下次启动时可以通过 `exitState` 获得这些已保存数据。

### 小程序的开发

在 Javascript 的基础上，我们增加了一些功能，以方便小程序的开发：

- 增加 App 和 Page 构造器，进行小程序的注册和页面的注册。
- 增加 getApp 和 getCurrentPages 方法，分别用来获取 App 实例和当前页面栈。
- 提供丰富的API，如扫一扫、支付等微信特有能力。
- 提供模块化能力，每个页面有独立的作用域。

>  小程序框架的逻辑层并非运行在浏览器中，隐私 Javascript 在 web 中一些能力都无法使用，window, document，dom操作等。

- app 小程序构造器
- page 页面构造器
- 响应式数据绑定
- 组件
- api
- 自定义组件

## 小程序配置

### JSON 语法

看起来同 JavaScript 的对象表达方式十分相似，但是有所不同。

JSON的Key必须包裹在一个双引号中，在实践中，编写 JSON 的时候，忘了给 Key 值加双引号或者是把双引号写成单引号是常见错误。

### app.json 配置
app.json 是当前小程序的全局配置，包括了小程序所有页面、界面表现、底部tab等。

```json
{
  "pages":[
    "pages/index/index",
    "pages/logs/logs"
  ],
  "window":{
    "backgroundTextStyle":"light",
    "navigationBarBackgroundColor": "#fff",
    "navigationBarTitleText": "WeChat",
    "navigationBarTextStyle":"black"
  }
}
```

### 页面配置

每个小程序页面也可以使用同名的.json 文件来对本页面的窗口表现进行配置，页面中的配置项会覆盖app.json 的 window 中相同的配置项。


> 相同的配置项，页面的配置项优先级高于 app.json

小程序开发及其原理
志愿者小程序业务功能介绍  招募小程序重构者 1个人或者2个人  
前期阶段 需要先梳理业务和代码逻辑 熟悉了这些方便后期的维护和重构。